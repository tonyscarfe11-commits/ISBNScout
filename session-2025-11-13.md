# ISBNScout Development Session - November 13, 2025

## Summary
Fixed critical camera scanning bugs on mobile, implemented SQLite persistent storage, and added comprehensive API usage tracking to prevent hitting eBay's 5,000/day rate limit.

---

## 1. Camera Scanning Fixes (Mobile Safari)

### Issue 1: Camera Stuck on "Starting Camera..."
- **Problem**: Video feed not initializing on iPhone Safari despite camera permission granted
- **Root Cause**: Video element only rendered when `isCameraActive` was true, creating chicken-and-egg problem
- **Solution**: Changed video element to always render but hidden with CSS
- **File**: `client/src/components/ScannerInterface.tsx`
- **Fix**:
```tsx
<video
  ref={videoRef}
  autoPlay
  playsInline
  muted  // Added for Safari compatibility
  className={`w-full h-full object-cover ${!isCameraActive ? 'hidden' : ''}`}
/>
```

### Issue 2: Duplicate Barcode Scans (50+ times)
- **Problem**: Same barcode scanned repeatedly causing UI flickering and burning through API calls
- **Root Cause**: ZXing continuously detecting barcode in every frame before camera could stop
- **Solution**: Added `isProcessingRef` flag and immediate camera stop
- **File**: `client/src/components/ScannerInterface.tsx`
- **Fix**:
```typescript
const isProcessingRef = useRef(false);

if (result && !isProcessingRef.current) {
  const cleanedText = text.replace(/[-\s]/g, "");
  if (/^\d{10}(\d{3})?$/.test(cleanedText)) {
    isProcessingRef.current = true; // Set flag immediately

    if (codeReaderRef.current) {
      try {
        codeReaderRef.current.reset();
      } catch (e) {}
    }
    stopCamera();

    setTimeout(() => {
      onIsbnScan(cleanedText);
    }, 100);
  }
}
```

---

## 2. Currency Fix

### Issue: Showing $ instead of ¬£
- **Problem**: Prices displayed in dollars ($5.90) instead of British pounds (¬£5.90)
- **Solution**: Changed all currency symbols from $ to ¬£
- **File**: `client/src/components/BookDetailsModal.tsx`
- **Lines Changed**: 126, 134, 158

---

## 3. SQLite Persistent Storage Migration

### Migration from In-Memory to SQLite
- **Reason**: Data lost on server restarts
- **Package**: better-sqlite3
- **Database File**: `isbn-scout.db` (52KB)

### Files Modified:
1. **`server/sqlite-storage.ts`** (NEW)
   - Complete SQLite implementation of IStorage interface
   - Tables: users, api_credentials, books, listings, api_usage
   - Foreign keys enabled with `this.db.pragma("foreign_keys = ON")`
   - Auto-creates default user to prevent FK constraint errors

2. **`server/storage.ts`**
   - Added `updateBook()` method to IStorage interface
   - Switched export from MemStorage to SQLiteStorage:
   ```typescript
   import { SQLiteStorage } from "./sqlite-storage";
   export const storage = new SQLiteStorage();
   ```

### Default User Fix
- **Issue**: Foreign key constraint failed during scan
- **Cause**: Books reference userId "default-user" but user didn't exist
- **Fix**: Auto-create default user in database initialization:
```typescript
const defaultUser = this.db.prepare("SELECT id FROM users WHERE id = ?").get("default-user");
if (!defaultUser) {
  // Create default user
}
```

---

## 4. Price Persistence Fix

### Issue: Prices Disappeared After Refresh
- **Problem**: eBay prices fetched and displayed but not saved to database
- **Solution**: Save prices after fetching

### Files Modified:

1. **`server/routes.ts`**
   - Added PATCH `/api/books/:isbn` endpoint:
   ```typescript
   app.patch("/api/books/:isbn", async (req, res) => {
     const { isbn } = req.params;
     const updates = req.body;
     const updatedBook = await storage.updateBook(isbn, updates);
     res.json(updatedBook);
   });
   ```

2. **`client/src/pages/ScanPage.tsx`**
   - Added price persistence after fetching:
   ```typescript
   if (ebayPrice !== undefined || amazonPrice !== undefined) {
     await fetch(`/api/books/${isbn}`, {
       method: "PATCH",
       headers: { "Content-Type": "application/json" },
       body: JSON.stringify({
         ebayPrice,
         amazonPrice,
         status: ebayPrice ? "profitable" : "pending"
       }),
     });
   }
   ```

---

## 5. API Usage Tracking System

### Context
- Hit eBay's 5,000/day rate limit (mostly due to duplicate scan bug)
- Need to track usage to prevent future issues

### Implementation:

#### 5.1 Database Schema
**File**: `server/sqlite-storage.ts`
```sql
CREATE TABLE IF NOT EXISTS api_usage (
  id TEXT PRIMARY KEY,
  service TEXT NOT NULL,
  date TEXT NOT NULL,
  callCount INTEGER NOT NULL DEFAULT 0,
  UNIQUE(service, date)
)
```

#### 5.2 Storage Methods
**File**: `server/sqlite-storage.ts`
- `incrementApiCall(service: string)`: Increment daily counter
- `getApiUsage(service: string, date?: string)`: Get usage for specific date
- `getAllApiUsage()`: Get all historical usage data

#### 5.3 eBay Service Integration
**File**: `server/ebay-pricing-service.ts`
```typescript
// Track API usage after successful fetch
if (this.storage) {
  this.storage.incrementApiCall('ebay');
}

// Export singleton with storage
export const ebayPricingService = new EbayPricingService(undefined, storage as any);
```

#### 5.4 API Endpoint
**File**: `server/routes.ts`
```typescript
app.get("/api/usage", async (req, res) => {
  const usage = (storage as any).getAllApiUsage();
  const today = new Date().toISOString().split('T')[0];
  const ebayUsageToday = (storage as any).getApiUsage('ebay', today);

  res.json({
    all: usage,
    today: {
      ebay: ebayUsageToday || { service: 'ebay', date: today, callCount: 0 }
    },
    limits: {
      ebay: { daily: 5000, remaining: 5000 - (ebayUsageToday?.callCount || 0) }
    }
  });
});
```

#### 5.5 UI Display
**File**: `client/src/pages/SettingsPage.tsx`
- Added "API Usage Today" card
- Real-time updates every 30 seconds
- Warning badges:
  - üî¥ "Low Limit" when < 1,000 calls remaining
  - ‚ö†Ô∏è "Warning" when 1,000-2,000 calls remaining
- Shows: calls used, remaining calls, reset time

```tsx
<Card className="p-4">
  <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
    <Activity className="h-5 w-5" />
    API Usage Today
  </h2>
  <div className="space-y-3">
    <div className="flex items-center justify-between p-3 border rounded-lg">
      <div>
        <p className="text-sm font-medium">eBay API</p>
        <p className="text-xs text-muted-foreground">
          {apiUsage.ebay.callCount.toLocaleString()} / 5,000 calls used
        </p>
      </div>
      <div className="text-right">
        <p className="text-2xl font-bold font-mono">
          {apiUsage.ebay.remaining.toLocaleString()}
        </p>
        <p className="text-xs text-muted-foreground">remaining</p>
        {/* Warning badges */}
      </div>
    </div>
  </div>
</Card>
```

---

## Current Status

### Working Features:
- ‚úÖ Camera barcode scanning (mobile Safari)
- ‚úÖ Duplicate scan prevention
- ‚úÖ SQLite persistent storage
- ‚úÖ Price data persistence
- ‚úÖ Currency display (¬£ GBP)
- ‚úÖ API usage tracking and monitoring

### Known Issues:
- ‚ö†Ô∏è eBay API limit hit today (5,000/5,000 used)
- ‚ÑπÔ∏è Resets at 8:00 AM GMT (midnight PST) tomorrow
- ‚ÑπÔ∏è App uses mock prices when rate limited

### Database:
- File: `isbn-scout.db` (52KB)
- Tables: users, api_credentials, books, listings, api_usage
- Default user: "default-user" (default@isbnscout.com)

---

## Next Session

When continuing:
1. Verify API tracking works after rate limit resets tomorrow
2. Test that counter increments correctly with each scan
3. Consider adding:
   - Amazon Product Advertising API integration
   - Multiple user accounts
   - Historical price tracking
   - Profit calculator improvements
   - Export functionality for scanned books

---

## Key Files Modified Today

1. `client/src/components/ScannerInterface.tsx` - Camera fixes
2. `client/src/components/BookDetailsModal.tsx` - Currency fix
3. `client/src/pages/ScanPage.tsx` - Price persistence
4. `client/src/pages/SettingsPage.tsx` - API usage UI
5. `server/sqlite-storage.ts` - NEW SQLite implementation
6. `server/storage.ts` - Storage interface updates
7. `server/routes.ts` - New endpoints (PATCH /api/books/:isbn, GET /api/usage)
8. `server/ebay-pricing-service.ts` - API tracking integration

---

## Testing Notes

- Tested on: iPhone Safari, Desktop browser
- Database persistence: Verified across server restarts
- API tracking: Starts fresh, previous usage not retroactively tracked
- Rate limit: Currently at maximum, resets tomorrow

---

*Session completed: November 13, 2025*
